<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: jsClean.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: jsClean.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileOverview jsClean
   Unpacker/deobfuscator for javascript sources 
 * @author Lorenzo Stella &lt;lorenzo.stl@gmail.com>
 * @version 1.0.0
 */
var beautify = require('js-beautify').js_beautify,
    fs = require('fs');

/**
 * The inputFile path can be hardcoded if needed
 * @const {string}
 */
var inputFile = "";

/**
 * The regular expression to locate the array with the codebase strings
 * @const {RegExp}
 */
var arrayRegex = /^.*var (.+?) = (\[([^\]])*\]?.*)/m; // we take the whole line because of a possible "a[href=mylink]" item in the strings array
var matches = [];

/**
 * Object for setting the optional arguments status
 * @enum {bool}
 */
var options = {
    expandArray: false
};
var OUTPUT = "";

/**
 * Checks for valid input path strings and optional arguments in the ARGVs
 */
process.argv.forEach(function(val, index, array) {
    if (val.substring(val.length - 8, val.length) !== "jsClean.js" &amp;&amp;
        val.substring(val.length - 4, val.length) !== "node" &amp;&amp;
        val.substring(0, 2) !== "--")
        inputFile = val;

    switch (val) {
        case "--expandArray":
            options.expandArray = true;
            break;
    }

    if (array.length === index + 1)
        if (inputFile === "")
            throwError("Missing input file.");
        else
            fs.readFile(inputFile, 'utf8', function(err, data) {
                if (err)
                    throwError(err.message);
                else {
                    OUTPUT = beautify(data, {
                        indent_size: 2,
                        unescape_strings: true,
                        keep_array_indentation: false,
                        preserve_newlines: false
                    });
                    if (options.expandArray) //dirty hack: the .exec to get the array pointers seems to be buggy so we iterate the function two times
                        expandArray(OUTPUT, function(javascriptSource) {
                        expandArray(javascriptSource, function(javascriptSource) {
                            OUTPUT = javascriptSource;
                        });
                    });

                    console.log(OUTPUT);
                }
            });
});

/**
 * Expand the string array 
 * @params {string} javascriptSource The target source to unpack
 * @function linecallback Callback function to return the result
 */
function expandArray(javascriptSource, callback) {

    var matchedArray = arrayRegex.exec(javascriptSource);
    var stringsArray = eval(matchedArray[2]); //should be safe
    var stringsArrayVarName = matchedArray[1];
    var varNameRegex = new RegExp(stringsArrayVarName + "(\\[([[\\d\\]]*?)\\])", "g");

    var notEOF = true;
    while (notEOF) {
        matches = varNameRegex.exec(javascriptSource);
        if (matches == null) {
            notEOF = false;
            callback(javascriptSource);
            break;
        }
        javascriptSource = javascriptSource.replace(new RegExp(escapeRegExp(matches[0]), 'g'), "\"" + stringsArray[matches[2]] + "\"");

    }

}

/**
 * Escape a string to RegExp
 * @params {string} str The target string
 */
function escapeRegExp(str) {
    return str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

/**
 * Throws formatted errors and quit the process
 * @params {string} errormessage The designed error message to display
 */
function throwError(errormessage) {
    console.error("[!] " + errormessage);
    process.exit(1);
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#arrayRegex">arrayRegex</a></li><li><a href="global.html#escapeRegExp">escapeRegExp</a></li><li><a href="global.html#inputFile">inputFile</a></li><li><a href="global.html#linecallbackCallbackfunctiontoreturntheresult">linecallback Callback function to return the result</a></li><li><a href="global.html#options">options</a></li><li><a href="global.html#throwError">throwError</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Apr 07 2016 15:26:25 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
